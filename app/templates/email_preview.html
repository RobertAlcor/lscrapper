{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <h3>Email-Vorschau: {{ tpl }} – Lead #{{ idx+1 }} von {{ filename }}</h3>
  <div class="mb-3">
    <strong>Betreff:</strong> {{ subject }}
  </div>
  <div class="mb-3">
    <pre class="p-3 bg-light" style="white-space: pre-wrap;">{{ body }}</pre>
  </div>
  <button id="send-btn" class="btn btn-success">Jetzt senden</button>
  <a href="{{ url_for('email_dashboard', filename=filename) }}" class="btn btn-secondary ms-2">Zurück</a>
</div>

<script>
  // AJAX zum Abschicken via /send-email
  document.getElementById('send-btn').addEventListener('click', () => {
    fetch('/send-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        to: "{{ leads[idx].Email }}",
        subject: "{{ subject|e }}",
        body: "{{ body|e }}"
      })
    })
      .then(r => r.json())
      .then(js => {
        if (js.status === 'ok') alert('E-Mail erfolgreich gesendet!');
        else alert('Fehler: ' + js.message);
      });
  });
</script>
{% endblock %}
